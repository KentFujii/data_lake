- hosts: localhost
  debugger: on_failed
  tasks:
  # https://docs.ansible.com/ansible/latest/modules/list_of_clustering_modules.html#k8s
  - name: Create the data-lake namespace
    k8s:
      state: present
      src: "{{ playbook_dir }}/../k8s/namespace.yml"
  - name: Create the data-lake configmap
    k8s:
      state: present
      definition: "{{ lookup('template', playbook_dir + '/../k8s/config.j2.yml') }}"
    vars:
      openapi: "{{ lookup('file', playbook_dir + '/../../openapi.yml') }}"
      airflow: "{{ lookup('file', playbook_dir + '/../../airflow.cfg') }}"
      unittests: "{{ lookup('file', playbook_dir + '/../../unittests.cfg') }}"
  - name: Create the data-lake middlewares workloads
    k8s:
      state: present
      src: "{{ playbook_dir }}/../k8s/{{ item }}.yml"
    with_items:
    - postgres
    - redis
    - fake-gcs-server
    - apisprout
  - name: Create the data-lake initdb workloads
    k8s:
      state: present
      src: "{{ playbook_dir }}/../k8s/initdb.yml"
  # https://stackoverflow.com/questions/57433963/ansible-kubernetes-how-to-wait-for-a-job-completion
  # https://docs.ansible.com/ansible/latest/modules/k8s_info_module.html#k8s-info-module
